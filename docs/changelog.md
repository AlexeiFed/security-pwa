# Changelog

## [2025-06-27] - Обновление системы уведомлений

### Добавлено
- **Механизм уведомления об обновлениях PWA**
  - Компонент `UpdateNotification` для отображения уведомления о новой версии
  - Автоматическое определение доступных обновлений через Service Worker
  - Кнопки "Обновить" и "Позже" для управления обновлением
  - Анимированная иконка обновления с вращением
  - Стилизованное модальное окно с затемнением фона

### Изменено
- **Service Worker активирован** в `index.tsx` для поддержки PWA функций
- **App.tsx** интегрирован с системой уведомлений об обновлениях
- Добавлены обработчики событий обновления Service Worker

### Технические детали
- Уведомление появляется автоматически при обнаружении новой версии
- При нажатии "Обновить" происходит перезагрузка страницы с новой версией
- При нажатии "Позже" уведомление скрывается до следующего обновления
- Система работает только в production режиме

## [2025-06-27] - Система тревожных оповещений

### Добавлено
- **Сервис звукового сигнала** (`services/alarmSound.ts`)
  - Функция `playAlarm()` для воспроизведения тревожного сигнала
  - Мигающий красный экран при активации тревоги
  - Автоматическое прекращение сигнала при сбросе тревоги

- **Алгоритм фильтрации оповещений**
  - Поля `forUserIds` и `forRoles` в структуре Alert
  - Логика определения получателей оповещений:
    - **Админ активирует тревогу** → сигнал у всех пользователей
    - **Инспектор активирует тревогу** → сигнал у админа и всех инспекторов
    - **Куратор активирует тревогу** → сигнал у админа и всех инспекторов

- **Тревожные кнопки для всех ролей**
  - Админ: тревожная кнопка в хедере панели администратора
  - Инспектор: тревожная кнопка в хедере панели инспектора
  - Куратор: тревожная кнопка в хедере панели куратора

- **Push-уведомления для закрытого приложения**
  - OneSignal для отправки push-уведомлений
  - Автоматическая отправка при создании тревоги
  - Сохранение push-подписок пользователей
  - Звук и вибрация в push-уведомлениях
  - Кнопки действий в уведомлениях
  - Бесплатный тариф до 10 000 подписчиков

### Изменено
- **Сервис alerts.ts** расширен для поддержки фильтрации
- **subscribeActiveAlert** теперь учитывает роли и ID пользователей
- **playAlarm** вызывается только через подписку, а не локально
- **Все панели** теперь подписаны на тревожные оповещения с передачей пользователя
- **Единообразный красный экран** для всех ролей с мигающей анимацией
- **Service Worker** обновлен для обработки push-уведомлений
- **Удалена папка functions** - заменена на OneSignal

### Исправлено
- **Устранена проблема** с отсутствием тревожных оповещений у инспекторов
- Устранено дублирование звуковых сигналов
- Исправлена логика определения получателей оповещений
- Добавлена анимация мигания `alarm-blink` в CSS
- **Теперь тревожные сигналы работают даже когда приложение закрыто**

## [2025-06-27] - UI/UX страницы куратора

### Добавлено
- **Модальное окно изменения статуса** куратора (работает, болен, командировка)
- **Анимация удаления** объекта с надписью "Объект удаляется..."
- **Подсказки для всех иконок** действий
- **Отображение количества объектов** в карточках кураторов

### Изменено
- **Верхний отступ исправлен**, хедер закреплён сверху
- **Заголовок "Объекты куратора"** вынесен из карточки
- **Кнопка "Добавить объекты"** перемещена справа от заголовка
- **Карта размещена справа** от списка объектов
- **Телефон куратора** отображается под ФИО вместо email
- **Email в карточках** выровнен по левому краю
- **Иконка редактирования** заменена на "+"
- **Иконка удаления** всегда красная
- **Все стили и отступы** приведены к единому виду

### Исправлено
- Устранены несоответствия в дизайне между страницами
- Исправлены отступы и выравнивание элементов

## [2025-06-27] - Модальное окно создания куратора

### Изменено
- **Убрано поле "Телефон"** из формы создания
- **Добавлен индикатор** "Создаются данные для куратора..." при создании
- **Поля логина и пароля** имеют прозрачный фон

### Исправлено
- Улучшена UX при создании куратора

## [2025-06-27] - Публикация и деплой

### Добавлено
- **Инструкции по сборке** (`npm run build`)
- **Настройка Firebase Hosting** для деплоя
- **Процесс публикации** на сервере

### Технические детали
- Приложение готово к мобильному тестированию
- Настроены файлы конфигурации Firebase
- Документация обновлена с инструкциями по деплою

## [2025-06-27] - Линтер и качество кода

### Статус
- **Критических ошибок нет**
- **Только предупреждения** (неиспользуемые импорты, зависимости useEffect)
- **Рекомендации по устранению** предупреждений предоставлены

### Рекомендации
- Удалить неиспользуемые импорты
- Добавить зависимости в useEffect где необходимо
- Рассмотреть использование useCallback для оптимизации 

## 2025-07-11

### OneSignal (Web Push)
- Переписана инициализация OneSignal на push-стиль через `window.OneSignal.push`, как рекомендует официальная документация для SPA/PWA.
- Все вызовы, связанные с пользователем (login, setExternalUserId), теперь выполняются только после события `initialized`.
- Для корректной работы OneSignal добавлены файлы `OneSignalSDKWorker.js` и `OneSignalSDKUpdaterWorker.js` в папку `public/` с содержимым:
  ```js
  importScripts('https://cdn.onesignal.com/sdks/OneSignalSDKWorker.js');
  ```
- Проверено: объект User появляется, методы для установки внешнего ID работают корректно.

### Звук тревоги
- Ошибка `NotAllowedError: play() failed because the user didn't interact with the document first` связана с политикой браузеров: автозапуск звука возможен только после взаимодействия пользователя (клик, тап и т.д.).
- Рекомендация: запускать тревожный звук только после любого пользовательского действия (например, после клика по кнопке или подтверждения).

### Проблема: синий экран при повторном запуске PWA
- Если приложение закрыто полностью (выгружено из памяти) и затем запускается снова, появляется только синий экран.
- Возможные причины:
  - Ошибка инициализации приложения или контекста авторизации.
  - Неудачная инициализация OneSignal или других сервисов (например, если нет сети).
  - Ошибка в service worker или кэшировании.
- Рекомендации по диагностике:
  1. Проверить консоль браузера на устройстве (DevTools → Remote Debugging) — есть ли ошибки при старте?
  2. Проверить, не блокирует ли загрузку сервис-воркер или кэш.
  3. Проверить, корректно ли инициализируются все сервисы (OneSignal, Firebase и т.д.) при fresh start.
  4. Очистить кэш приложения и попробовать снова.
- Для воспроизведения и отладки проблемы желательно получить логи с устройства.

--- 